<!--
=====================================================
  SISTEMA DE INVENTARIO F√çSICO 2026
  ¬© Derechos reservados DAS Logistics Solutions S.A.C
  Prohibida su copia, modificaci√≥n o distribuci√≥n
  sin autorizaci√≥n expresa del autor.

  Programador: Anthony Carranza Paredes
=====================================================
-->

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario F√≠sico 2026</title>

<style>
:root{
  --azul:#0b3c5d;
  --gris:#f4f6f8;
  --naranja:#f28c28;
}

*{box-sizing:border-box;font-family:Segoe UI,Tahoma,sans-serif}

body{margin:0;padding:20px;background:var(--gris)}

.header{text-align:center;margin-bottom:20px}
.header img{height:80px}

.dni-box{
  background:white;
  padding:15px;
  border-radius:12px;
  max-width:400px;
  margin:0 auto 20px auto;
}

.tabs{display:flex;background:white;border-radius:12px;overflow:hidden;margin-bottom:15px}
.tab{flex:1;padding:12px;text-align:center;cursor:pointer;background:#e9edf1}
.tab.active{background:white;border-bottom:3px solid var(--naranja)}

.card{background:white;padding:20px;border-radius:15px}
.hidden{display:none}

label{font-weight:600;margin-top:12px;display:block}
.req{color:#888}

input,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  font-size:15px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{background:var(--azul);color:white;border:none;margin-top:15px;cursor:pointer}

.flex{display:flex;gap:12px}
.flex>div{flex:1}

.list{
  border:1px solid #ddd;
  max-height:220px;
  overflow-y:auto;
  border-radius:8px;
}

.option{padding:8px;cursor:pointer;border-bottom:1px solid #eee}
.option:hover{background:#f1f5f9}

/* ===== ESTILO MIS REGISTROS (COPIADO DEL C√ìDIGO QUE TE GUSTABA) ===== */
.registro{
  padding:10px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  gap:10px;
}

.btn-del{
  width:32px;
  height:32px;
  background:#e5e7eb;
  border:none;
  border-radius:6px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  line-height:1;
  padding:0;
}
/* ================================================================ */

.footer{
  text-align:center;
  margin-top:60px;
  font-size:14px;
}

/* ===== SOLO EST√âTICA REGISTRAR POR UBICACI√ìN ===== */
.cant-uni{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:6px;
}
.cant-uni input{width:90px}
.cant-uni span{font-weight:600}
</style>
</head>

<body>

<div class="header">
  <img src="logo_dassac.png">
</div>

<div class="dni-box" id="dniBox">
  <label>DNI <span class="req">*</span></label>
  <input id="dniInput">
  <button onclick="confirmarDNI()">Ingresar</button>
</div>

<div id="app" class="hidden">

<div class="dni-box">
  DNI: <b id="dniFijo"></b>
</div>

<div class="tabs">
  <div class="tab active" onclick="mostrarTab('reg',this)">Registrar</div>
  <div class="tab" onclick="mostrarTab('ubi',this)">Registrar por ubicaci√≥n</div>
  <div class="tab" onclick="mostrarTab('mis',this)">
    Mis registros (<span id="contador">0</span>)
  </div>
</div>

<div id="tab-reg" class="card">
  <label>C√≥digo del item <span class="req">*</span></label>
  <input id="codigo" onkeyup="filtrarItems()">
  <div id="listaItems" class="list hidden"></div>

  <label>Ubicaci√≥n <span class="req">*</span></label>
  <input id="ubicacion">

  <div class="flex">
    <div>
      <label>Cantidad <span class="req">*</span></label>
      <input id="cantidad" type="number" min="0">
    </div>
    <div>
      <label>Unidad de medida</label>
      <input id="unidad" readonly>
    </div>
  </div>

  <label>Observaciones</label>
  <input id="obs">

  <button onclick="guardar()">Guardar</button>
</div>

<div id="tab-ubi" class="card hidden">
  <label>Ubicaci√≥n <span class="req">*</span></label>
  <input id="ubicacionMasiva" onkeyup="filtrarUbicaciones()">
  <div id="listaUbicaciones" class="list hidden"></div>

  <button onclick="cargarPorUbicacion()">Cargar items</button>
  <div id="listaUbicacion" style="margin-top:20px"></div>
  <button onclick="guardarPorUbicacion()">Guardar</button>
</div>

<div id="tab-mis" class="card hidden">
  <button onclick="exportar()">Exportar CSV</button>
  <div id="listaRegistros"></div>
</div>

</div>

<div class="footer">
  <h2>Inventario F√≠sico 2026</h2>
  ¬© Derechos reservados DAS Logistics Solutions S.A.C<br>
  Programador: <strong>Anthony Carranza Paredes</strong>
</div>

<script src="datos_items.js"></script>

<script>
let catalogo=[],registros=[],dni="";
let itemsUbicacion=[],ubicaciones=[];

document.addEventListener("DOMContentLoaded",()=>{
  catalogo=Object.entries(window.catalogoCompleto).map(([c,d])=>({...d,codigo:c}));
  ubicaciones=[...new Set(catalogo.map(i=>i.ubicacion).filter(u=>u))];
});

function confirmarDNI(){
  dni=dniInput.value.trim();
  if(!dni)return alert("Ingrese DNI");
  dniFijo.innerText=dni;
  dniBox.classList.add("hidden");
  app.classList.remove("hidden");
}

function mostrarTab(tab,el){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
  document.querySelectorAll("[id^='tab-']").forEach(d=>d.classList.add("hidden"));
  document.getElementById("tab-"+tab).classList.remove("hidden");
}

function filtrarItems(){
  const v=codigo.value.toLowerCase();
  if(v.length<2){listaItems.classList.add("hidden");return;}
  const f=catalogo.filter(i=>i.codigo.includes(v)).slice(0,10);
  listaItems.innerHTML=f.map(i=>`
    <div class="option" onmousedown="seleccionarItem('${i.codigo}')">
      ${i.codigo} - ${i.descripcion}
    </div>`).join("");
  listaItems.classList.remove("hidden");
}

function seleccionarItem(c){
  const i=catalogo.find(x=>x.codigo===c);
  codigo.value=i.codigo;
  ubicacion.value=i.ubicacion||"";
  cantidad.value=i.saldo??"";
  unidad.value=i.unidad||"";
  listaItems.classList.add("hidden");
}

function guardar(){
  registros.push({
    codigo:codigo.value,
    ubicacion:ubicacion.value,
    cantidad:cantidad.value,
    unidad:unidad.value,
    observaciones:obs.value
  });
  codigo.value=ubicacion.value=cantidad.value=unidad.value=obs.value="";
  actualizar();
}

function filtrarUbicaciones(){
  const v=ubicacionMasiva.value.toLowerCase();
  if(!v){listaUbicaciones.classList.add("hidden");return;}
  const f=ubicaciones.filter(u=>u.toLowerCase().includes(v)).slice(0,10);
  listaUbicaciones.innerHTML=f.map(u=>`
    <div class="option" onmousedown="
      ubicacionMasiva.value='${u}';
      listaUbicaciones.classList.add('hidden');
    ">${u}</div>`).join("");
  listaUbicaciones.classList.remove("hidden");
}

function cargarPorUbicacion(){
  const ub=ubicacionMasiva.value.trim();
  if(!ub)return alert("Ingrese ubicaci√≥n");

  itemsUbicacion=catalogo.filter(i=>i.ubicacion===ub && Number(i.saldo)>0);

  listaUbicacion.innerHTML=itemsUbicacion.map((i,idx)=>`
    <div class="registro">
      <div style="width:100%">
        <b>${i.codigo}</b> - ${i.descripcion}
        <div class="cant-uni">
          <input type="number" min="0" value="${i.saldo}" id="cantU_${idx}">
          <span>${i.unidad}</span>
        </div>
        Observaciones:
        <input id="obsU_${idx}">
      </div>
    </div>`).join("");
}

function guardarPorUbicacion(){
  itemsUbicacion.forEach((i,idx)=>{
    const c=Number(document.getElementById(`cantU_${idx}`).value);
    const o=document.getElementById(`obsU_${idx}`).value;
    if(c>0){
      registros.push({
        codigo:i.codigo,
        ubicacion:i.ubicacion,
        cantidad:c,
        unidad:i.unidad,
        observaciones:o
      });
    }
  });
  itemsUbicacion=[];
  ubicacionMasiva.value="";
  listaUbicacion.innerHTML="";
  actualizar();
}

function actualizar(){
  contador.innerText=registros.length;
  listaRegistros.innerHTML=registros.map((r,i)=>`
    <div class="registro">
      <div>
        <b>${i+1}. ${r.codigo}</b><br>
        Ubicaci√≥n: ${r.ubicacion}<br>
        Cantidad: ${r.cantidad} ${r.unidad}
        ${r.observaciones?`<br><small>Obs: ${r.observaciones}</small>`:""}
      </div>
    <button class="btn-del" onclick="borrarRegistro(${i})">üóëÔ∏è</button>
    </div>`).join("");
}

function exportar(){
  if (!registros.length) {
    alert("No hay registros para exportar.");
    return;
  }

  let csv = "DNI,C√≥digo,Ubicaci√≥n,Cantidad,Unidad,Observaciones\n";
  registros.forEach(r => {
    csv += `${dni},${r.codigo},${r.ubicacion},${r.cantidad},${r.unidad},"${r.observaciones || ""}"\n`;
  });

  const fecha = new Date().toISOString().replace(/[:.]/g, "-");
  const nombreArchivo = `inventario_${dni}_${fecha}.csv`;

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = nombreArchivo;
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  registros = [];
  actualizar();
}

function borrarRegistro(i){
  if(confirm("¬øEst√° seguro de eliminar este registro?")){
    registros.splice(i,1);
    actualizar();
  }
}

window.addEventListener("beforeunload", function (e) {
  if (typeof registros !== "undefined" && registros.length > 0) {
    e.preventDefault();
    e.returnValue = "Tiene registros sin exportar. Exporte antes de salir para no perder informaci√≥n.";
  }
});

history.pushState(null, "", location.href);

window.addEventListener("popstate", function () {
  history.pushState(null, "", location.href);
  if (typeof registros !== "undefined" && registros.length > 0) {
    alert("Antes de salir debe exportar los registros para no perder informaci√≥n.");
  }
});

</script>

</body>
</html>
